##############################################################################
# NuVatis Testcontainers E2E (주간 스케줄)
#
# 작성자: 최진호
# 작성일: 2026-02-26
#
# 트리거: 매주 일요일 03:00 UTC, 수동
# 동작: PostgreSQL, MySQL 컨테이너로 다중 DB 버전 E2E 테스트 실행
##############################################################################

name: E2E Testcontainers

on:
  schedule:
    - cron: '0 3 * * 0'
  workflow_dispatch:

env:
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true

jobs:
  e2e-postgres:
    name: PostgreSQL E2E
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        pg-version: ['13', '14', '15', '16']

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '8.0.x'

      - name: Build
        run: dotnet build tests/NuVatis.Tests/NuVatis.Tests.csproj --configuration Release

      - name: Run PostgreSQL ${{ matrix.pg-version }} E2E
        env:
          TC_PG_IMAGE: postgres:${{ matrix.pg-version }}-alpine
        run: |
          dotnet test tests/NuVatis.Tests/NuVatis.Tests.csproj \
            --configuration Release \
            --no-build \
            --filter "Category=Testcontainers" \
            --logger "console;verbosity=normal"

  e2e-mysql:
    name: MySQL E2E
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        mysql-version: ['8.0', '8.4']

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '8.0.x'

      - name: Build
        run: dotnet build tests/NuVatis.Tests/NuVatis.Tests.csproj --configuration Release

      - name: Run MySQL ${{ matrix.mysql-version }} E2E
        env:
          TC_MYSQL_IMAGE: mysql:${{ matrix.mysql-version }}
        run: |
          dotnet test tests/NuVatis.Tests/NuVatis.Tests.csproj \
            --configuration Release \
            --no-build \
            --filter "Category=Testcontainers" \
            --logger "console;verbosity=normal"
